<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
		<meta name="theme-color" content="#0b0f17">

		<!-- iOS Add-to-Home-Screen / standalone -->
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

		<title>PDST — PLS DONATE Shop Timer</title>

		<link rel="icon" href="favicon.ico" sizes="any">
		<link rel="stylesheet" href="./assets/site.css">
	</head>

	<body>
		<div class="wrap">
			<header>
				<div style="text-align: center;">
					<h1>PDST — PLS DONATE Shop Timer</h1>
					<div class="sub" id="headerDesc">
						Resets every <code class="inline">3 days</code> at <code class="inline">00:00 UTC</code>.
					</div>
				</div>
			</header>

			<div id="toolbarFade" class="fadeScroll" style="margin-bottom:14px;">
				<div class="toolbar hScroll" id="toolbarScroll">
					<div class="pill" id="nowPill">Now: —</div>
					<div class="pill" id="localTzPill">Local TZ: —</div>
					<div class="pill" id="resetTzPill">Reset TZ: —</div>
				</div>
			</div>

			<div class="grid">
				<section class="card span2" style="width:100%;">
					<div class="head">
						<div class="title"><span class="statusDot" id="shopDot"></span>Shop Reset</div>
						<div class="tag">COUNTDOWN</div>
					</div>

					<div class="fadeWrap fadeScroll" id="shopFade">
						<div class="tableScroll" id="shopScroll">
							<table>
								<thead>
									<tr>
										<th style="width:28%">Timer</th>
										<th style="width:24%">Remaining</th>
										<th style="width:24%">Next (Local)</th>
										<!-- <th style="width:24%">Next (UTC)</th> -->
									</tr>
								</thead>
								<tbody id="shopBody"></tbody>
							</table>
						</div>
					</div>
				</section>
			</div>

			<div class="footer">
				<code class="inline" id="versionCode">v—</code>
			</div>

			<div class="tabsBar" style="width:100%;">
				<nav class="tabs" style="align-items:center;">
					<a class="tabBtn active" data-tab="timers" href="./"><span class="tabDot"></span> Timers</a>
					<a class="tabBtn" data-tab="about" href="./pages/about/"><span class="tabDot"></span> About</a>
					<a class="tabBtn" data-tab="settings" href="./pages/settings/"><span class="tabDot"></span> Settings</a>
				</nav>
			</div>
		</div>

		<script>
			// PDST reset rules
			const RESET_TZ = "UTC";
			const CYCLE_DAYS = 4; // change to 3 when confirmed
			const CYCLE_MS = CYCLE_DAYS * 86400 * 1000;

			// Replace with a known real reset moment at 00:00:00Z
			const ANCHOR_UTC = "2026-01-14T00:00:00Z";

			const LOCAL_TZ = Intl.DateTimeFormat().resolvedOptions().timeZone || "Local";

			// refs
			const headerDesc = document.getElementById("headerDesc");
			const shopBody = document.getElementById("shopBody");
			const nowPill = document.getElementById("nowPill");
			const localTzPill = document.getElementById("localTzPill");
			const resetTzPill = document.getElementById("resetTzPill");
			const shopDot = document.getElementById("shopDot");

			function pad2(n){ return String(n).padStart(2, "0"); }

			function escapeHtml(s){
				return String(s).replace(/[&<>"']/g, c => ({
					"&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#039;"
				}[c]));
			}

			function formatDuration(totalSec){
				totalSec = Math.max(0, Math.floor(totalSec));
				const days = Math.floor(totalSec / 86400);
				totalSec %= 86400;
				const hrs = Math.floor(totalSec / 3600);
				totalSec %= 3600;
				const mins = Math.floor(totalSec / 60);
				const secs = totalSec % 60;
				if (days > 0) return `${days}d ${pad2(hrs)}h ${pad2(mins)}m ${pad2(secs)}s`;
				return `${pad2(hrs)}h ${pad2(mins)}m ${pad2(secs)}s`;
			}

			function urgencyDot(dotEl, remainingSec){
				dotEl.classList.remove("warn","bad");
				if (remainingSec <= 300) dotEl.classList.add("bad");        // <= 5 min
				else if (remainingSec <= 3600) dotEl.classList.add("warn"); // <= 1 hour
			}

			function fmtUtc(d){
				return `${d.getUTCFullYear()}-${pad2(d.getUTCMonth()+1)}-${pad2(d.getUTCDate())} `
					+ `${pad2(d.getUTCHours())}:${pad2(d.getUTCMinutes())}:${pad2(d.getUTCSeconds())}`;
			}

			function fmtLocal(d){
				const parts = new Intl.DateTimeFormat("en-US", {
					timeZone: LOCAL_TZ,
					year:"numeric", month:"2-digit", day:"2-digit",
					hour:"2-digit", minute:"2-digit", second:"2-digit",
					hour12:false
				}).formatToParts(d);

				const map = {};
				for (const p of parts) if (p.type !== "literal") map[p.type] = p.value;

				return `${map.year}-${map.month}-${map.day} ${map.hour}:${map.minute}:${map.second}`;
			}

			function addRow(bodyEl, name, remainingStr, nextLocalStr, nextUtcStr){
				const tr = document.createElement("tr");
				tr.innerHTML = `
					<td>${escapeHtml(name)}</td>
					<td class="mono muted">${escapeHtml(remainingStr)}</td>
					<td class="mono muted">${escapeHtml(nextLocalStr)}</td>
					<!-- <td class="mono muted">${escapeHtml(nextUtcStr)}</td> -->
				`;
				bodyEl.appendChild(tr);
			}

			function computeNextReset(nowMs, anchorMs){
				if (nowMs <= anchorMs) return anchorMs;
				const elapsed = nowMs - anchorMs;
				const k = Math.floor(elapsed / CYCLE_MS) + 1; // smallest k where anchor+k*cycle > now
				return anchorMs + (k * CYCLE_MS);
			}

			function render(){
				const now = new Date();
				const nowMs = now.getTime();

				nowPill.textContent = `Now: ${now.toLocaleString(undefined, { hour12:false })}`;
				localTzPill.textContent = `Local TZ: ${LOCAL_TZ}`;
				resetTzPill.textContent = `Reset TZ: ${RESET_TZ}`;
				headerDesc.innerHTML = `Resets every <code class="inline">${CYCLE_DAYS} days</code> at <code class="inline">00:00 UTC</code>.`;

				shopBody.textContent = "";

				const anchor = new Date(ANCHOR_UTC);
				const anchorMs = anchor.getTime();

				if (!Number.isFinite(anchorMs)){
					addRow(shopBody, "Shop Reset", "CONFIG ERROR", "Invalid ANCHOR_UTC", "—");
					shopDot.classList.add("bad");
					return;
				}

				const nextMs = computeNextReset(nowMs, anchorMs);
				const next = new Date(nextMs);

				const remainingSec = Math.max(0, Math.floor((nextMs - nowMs) / 1000));
				urgencyDot(shopDot, remainingSec);

				addRow(
					shopBody,
					"Shop Reset",
					formatDuration(remainingSec),
					fmtLocal(next),
					fmtUtc(next)
				);

				if (window.__syncFades) window.__syncFades();
			}

			render();
			setInterval(render, 1000);
		</script>

		<script type="module">
			import {
				attachFadeToScroller,
				autoMarkActiveTab,
				initAppSettings,
				startOrbBackgroundFromSettings,
				_VERSION
			} from "./assets/site.js";

			document.getElementById("versionCode").textContent = `v${_VERSION}`;

			initAppSettings();

			const syncs = [];

			// Table fade wrapper (correct: scroller + wrapper)
			syncs.push(attachFadeToScroller(
				document.getElementById("shopScroll"),
				document.getElementById("shopFade")
			));

			// Toolbar fade wrapper (correct: scroller + wrapper)
			syncs.push(attachFadeToScroller(
				document.getElementById("toolbarScroll"),
				document.getElementById("toolbarFade")
			));

			window.__syncFades = () => {
				for (const fn of syncs) if (typeof fn === "function") fn();
			};
			window.__syncFades();

			startOrbBackgroundFromSettings({ spawnEveryMs: 1600, sizeMin: 640, sizeMax: 1800 });

			autoMarkActiveTab("timers");
		</script>
	</body>
</html>
